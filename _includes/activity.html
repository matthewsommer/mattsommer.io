<div ng-app="myApp" ng-controller="tasks">
    {% include task_nav.html %}
    <h2 ng-bind="title" ng-cloak></h2>
    <hr/>
    <div class="row flex-wrap-reverse">
        <div class="col-md-12">
        <div ng-repeat="project in projects" ng-cloak>
                <h4 ng-bind="project"></h4>
                <hr ng-cloak/>
                <table class="mb-3">
                    <tr ng-repeat="task in tasks" ng-if="task.fields.project.name == project " ng-cloak>
                        <td class="align-top">
                            <i ng-if="task.fields.status.name == 'In Progress' " class='fas fa-spinner' style='color:green; margin-left:0.5em; margin-right:0.5em;'></i>
                            <i ng-if="task.fields.status.name == 'Open' " class='far fa-circle' style='color:green; margin-left:0.5em; margin-right:0.5em;'></i>
                            <i ng-if="task.fields.status.name == 'Closed' " class='fas fa-check-circle' style='color:green; margin-left:0.5em; margin-right:0.5em;'></i>
                        </td>
                        <td>
                            <div ng-if="(task.fields.customfield_10905 || task.fields.customfield_10904) && task.fields.issuetype.name != 'Live Performance'" class="row" ng-cloak>
                            <div ng-cloak class="col-12">
                                    <span ng-if="task.fields.customfield_10904" ng-bind="shortDate(task.fields.customfield_10904)"></span>
                                    <span ng-if="task.fields.customfield_10905" ng-bind="' to ' + shortDate(task.fields.customfield_10905)"></span>
                                    <span ng-if="!task.fields.customfield_10905 && task.fields.customfield_10904" ng-bind="' to Present'"></span>
                                </div>
                            </div>
                            <div ng-if="task.fields.issuetype.name == 'Live Performance'" class="row" ng-cloak>
                                <div ng-cloak class="col-12">
                                    <span ng-if="task.fields.customfield_10904" ng-bind="longDate(task.fields.customfield_10904)"></span>
                                    <span ng-if="task.fields.customfield_10905" ng-bind="' to ' + longDate(task.fields.customfield_10905)"></span>
                                    <span ng-if="!task.fields.customfield_10905 && task.fields.customfield_10904" ng-bind="' to Present'"></span>
                                </div>
                            </div>
                            <a ng-href="/task/?id={%raw%}{{task.id}}{%endraw%}" ng-bind="task.fields.summary"></a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
app.controller('tasks', function($scope, $http) {
    function setView(tasks){
        var projects = $.unique(tasks.map(function (task) {return task.fields.project.name;}));
        projects.reverse();
        $scope.projects = projects;
        $scope.tasks = tasks;
        $scope.title = title;
        $scope.$digest();
    }
    getTasks(query,fields,setView);

    $scope.shortDate = function(date){
        var momentDate = moment(date, "YYYY-MM-DD'T'HH:MM:SS.sssZ").format("MMM Do, YYYY");
        if(momentDate != "Invalid date") {
            return momentDate;
        } else {
            return date;
        }
    };

    $scope.longDate = function(date){
        var momentDate = moment(date, "YYYY-MM-DD'T'HH:MM:SS.sssZ").format("MMM Do YYYY h:mm A");
        if(momentDate != "Invalid date") {
            return momentDate;
        } else {
            return date;
        }
    };
});
</script>