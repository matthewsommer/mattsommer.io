---
layout: default
---
{{ content }}
{% include task_nav.html %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.5/showdown.min.js"></script>
<div id="mylightbox"></div>
<div ng-app="myApp" ng-controller="task">
    <div class="row">
        <div class="col-12">
            <span ng-if="epic != null" ng-cloak>
                <span> {%raw%}{{task.fields.project.name}}{%endraw%} {%raw%}{{task.fields.issuetype.name}}{%endraw%}</span>
            </span>
            <span ng-if="epic == null" ng-cloak>
                <span>{%raw%}{{task.fields.project.name}}{%endraw%} {%raw%}{{task.fields.issuetype.name}}{%endraw%}</span>
            </span>
            <h3 ng-bind="task.fields.summary" class="mb-1" ng-cloak></h3>
            <div class="d-flex flex-md-row flex-column">
                <span ng-if="epic != null" class="mr-2" ng-cloak>{%raw%}{{epic.fields.project.name}}{%endraw%} Epic: </span>
                <span ng-if="epic != null">
                    <a ng-href="/task/?id={%raw%}{{epic.id}}{%endraw%}" ng-bind="epic.fields.summary" ng-cloak class="mr-1"></a> 
                </span>
            </div>

        </div>
    </div>
    <hr class="mb-2"/>
    <div class="row" ng-cloak>
        <div class="col-12">
            <img ng-if="task.fields.status.name == 'In Progress' " ng-src='https://img.shields.io/badge/Status-In--Progress-blue.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.status.name == 'Closed' " ng-src='https://img.shields.io/badge/Status-Closed-brightgreen.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.status.name == 'Open' " ng-src='https://img.shields.io/badge/Status-To--Do-red.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.priority.id == 1" ng-src='https://img.shields.io/badge/Priority-Highest-red.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.priority.id == 2" ng-src='https://img.shields.io/badge/Priority-High-orange.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.priority.id == 3" ng-src='https://img.shields.io/badge/Priority-Medium-blue.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.priority.id == 4" ng-src='https://img.shields.io/badge/Priority-Medium-blue.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="task.fields.priority.id == 5" ng-src='https://img.shields.io/badge/Priority-Medium-lightgrey.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <img ng-if="percentClosed != 'NaN'" ng-src='https://img.shields.io/badge/Progress-{%raw%}{{percentClosed}}%25{%endraw%}-brightgreen.svg' class='align-top' style="align-self: center" ng-cloak></img>
            <span><a ng-if="task" ng-href="https://timetopretend.atlassian.net/browse/{%raw%}{{task.key}}{%endraw%}" target='_blank' style='text-align:right' class='p-0 m-0' ng-cloak><i class='fas fa-database' ng-cloak></i></a></span>
            <span ng-if="percentClosed != 'NaN'" style="width:100%">
                <span class="progress" style="height: 7px;">
                    <div class="progress-bar bg-success ng-cloak" role="progressbar" style="width: {%raw%}{{percentClosed}}{%endraw%}%" aria-valuenow="{%raw%}{{percentClosed}}{%endraw%}" aria-valuemin="0" aria-valuemax="100"></div>
                </span>
            </span>
        </div>
    </div>
    <hr ng-if="task.renderedFields.description != null" class="mb-2 mt-2" ng-cloak/>
    <div ng-if="task.fields.components.length > 0" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <u><span class="mb-0">Topics:</span></u>
            <span class="mt-1 mb-1" ng-cloak>
                <span data-ng-repeat="component in task.fields.components"><a ng-href="{%raw%}{{component.description}}{%endraw%}" target="_blank">{%raw%}{{component.name}}{%endraw%}</a><font ng-show="!$last">, </font></span>
            </span>
            <div>
        </div>
            <hr ng-if="task.renderedFields.description != null"/>
        </div>
    </div>
    <div ng-if="(task.renderedFields.customfield_10905 || task.renderedFields.customfield_10904) && task.fields.issuetype.name != 'Live Performance'" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <span ng-if="task.renderedFields.customfield_10904" ng-bind="shortDate(task.renderedFields.customfield_10904)"></span>
            <span ng-if="task.renderedFields.customfield_10905" ng-bind="' to ' + shortDate(task.renderedFields.customfield_10905)"></span>
            <span ng-if="!task.renderedFields.customfield_10905 && task.renderedFields.customfield_10904"> to Present</span>
        </div>
    </div>
    <div ng-if="task.fields.issuetype.name == 'Live Performance'" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <span ng-if="task.renderedFields.customfield_10904" ng-bind="longDate(task.renderedFields.customfield_10904)"></span>
            <span ng-if="task.renderedFields.customfield_10905" ng-bind="' to ' + longDate(task.renderedFields.customfield_10905)"></span>
            <span ng-if="!task.renderedFields.customfield_10905 && task.renderedFields.customfield_10904"> to Present</span>
        </div>
    </div>
    <div ng-if="task.renderedFields.customfield_12405" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <h6><u>Root Cause</u></h6>
            <span ng-bind-html="task.renderedFields.customfield_12405"></span>
        </div>
    </div>
    <div ng-if="task.renderedFields.customfield_12402" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <h6><u>Corrective Action</u></h6>
            <span ng-bind-html="task.renderedFields.customfield_12402"></span>
        </div>
    </div>
    <div ng-if="task.renderedFields.customfield_12403" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <h6><u>Preventative Action</u></h6>
            <span ng-bind-html="task.renderedFields.customfield_12403"></span>
        </div>
    </div>
    <div ng-if="task.renderedFields.description != ''" class="row" ng-cloak>
            <div ng-cloak class="col-12">
                <span ng-if="task.renderedFields.description != null" ng-bind-html="task.renderedFields.description" ng-cloak></span>
            </div>
        </div>
    <div ng-if="task.renderedFields.description != null" class="row" ng-cloak>
        <div ng-cloak class="col-12">
            <div ng-repeat="detail in result.detail" ng-cloak>
                <div ng-repeat="repo in detail.repositories" ng-cloak>
                    <h5 ng-if="repo.commits.length > 0" class="mt-2" ng-cloak>Commits</h5>
                    <hr ng-if="repo.commits.length > 0" ng-cloak/>
                    <div ng-repeat="commit in repo.commits">
                        <a ng-href="{%raw%}{{commit.url}}{%endraw%}" ng-bind="commit.message" target="_blank"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div ng-if="stories.length > 0" class="row">
        <div class="col-12">
            <div ng-repeat="project in projects" ng-cloak>
                <h3>{%raw%}{{project}}{%endraw%} Stories</h3>
                <hr/>
                <table class="mb-3">
                    <tr ng-repeat="taskStory in stories" ng-if="taskStory.fields.project.name == project" ng-cloak>
                        <td class="align-top">
                            <i ng-if="taskStory.fields.status.id == 6" class='fas fa-check-circle mr-1' style='color:green;'></i>
                            <i ng-if="taskStory.fields.status.id == 3" class='fas fa-spinner mr-1' style='color:green;'></i>
                            <i ng-if="taskStory.fields.status.id == 1" class='far fa-circle mr-1' style='color:green;'></i>        
                        </td>
                        <td>
                            <a ng-href="/task/?id={%raw%}{{taskStory.id}}{%endraw%}" ng-bind="taskStory.fields.summary"></a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div ng-if="readme != null" class="row">
        <div class="col-12">
            <div ng-bind-html="readme"></div>
        </div>
    </div>
    <div ng-if="subtasks.length > 0" class="row" ng-cloak>
        <div class="col-12">
            <h5>Tasks</h5>
            <hr/>
            <div ng-repeat="subtaskId in task.fields.subtasks" ng-init="sectionIndex = $index" ng-cloak>
                <table>
                    <tr ng-repeat="subtask in subtasks" ng-if="subtask.id == subtaskId.id" ng-cloak>
                        <td class="align-top"><h5>
                            <i ng-if="subtask.fields.status.id == 6" class='fas fa-check-circle mr-1' style='color:green;'></i>
                            <i ng-if="subtask.fields.status.id == 3" class='fas fa-spinner mr-1' style='color:green;'></i>
                            <i ng-if="subtask.fields.status.id == 1" class='far fa-circle mr-1' style='color:green;'></i></h5>       
                        </td>
                        <td>
                            <u><span ng-bind="subtask.fields.summary" class="color-primary"></span></u>
                            <span ng-bind-html="subtask.renderedFields.description"></span>
                        </td>
                    </tr>
                </table>
                <hr/>
            </div>
        </div>
    </div>
    <h3 ng-if="task.fields.attachment.length > 0" ng-cloak>Pictures</h3>
    <hr ng-if="task.fields.attachment.length > 0" ng-cloak/>
    <div ng-if="task.fields.attachment.length > 0" class="row">
        <div ng-repeat="attachment in task.fields.attachment" class="col-md-4 mb-4">
            <a href="#" data-featherlight="{%raw%}{{attachment.content}}{%endraw%}"><img ng-src="{%raw%}{{attachment.thumbnail}}{%endraw%}" style="width: 100%"/></a>
        </div>
    </div>
</div>
{% include featherlight_scripts.html %}
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-sanitize.js"></script>
<script>
var app = angular.module('myApp', ['ngSanitize']);
app.controller('task', function($scope, $http) {
    
    function setStories(tasks) {
        $scope.stories = tasks;
        var projects = $.unique(tasks.map(function (task) {return task.fields.project.name;}));
        projects.reverse();
        $scope.percentClosed = ((tasks.filter((task) => task.fields.status.id == 6).length / tasks.length) * 100).toFixed(0);
        $scope.projects = projects;
        $scope.$digest();
    }

    function setSubtasks(tasks) {
        $scope.subtasks = tasks;
        $scope.percentClosed = ((tasks.filter((task) => task.fields.status.id == 6).length / tasks.length) * 100).toFixed(0);
        $scope.$digest();
    }

    function setRepo(result) {
        $scope.result = result;
        $scope.$digest();
    }

    function setReadme(html) {
        var converter = new showdown.Converter();
        $scope.readme = converter.makeHtml(html);
        $scope.$digest();
    }

    function setView(task,epic){
        $scope.task = task;
        $scope.epic = epic;
        getSubtasksAsync(task.id,setSubtasks);
        getTasksAsync("\"Epic%20Link\"%20%3D%20" + task.id + "&fields=summary,project,status", 0, setStories);
        getRepoData(id, setRepo);
        if(task.fields.customfield_11401 != null) {
            getReadme(setReadme);
        }
    }
    
    var id = getParameterByName("id");
    getTaskAsync(getParameterByName("id"),setView);

    $scope.shortDate = function(date){
        return moment(date, "DD/MMM/YY h:mm a").format("MMM Do, YYYY");
    };

    $scope.longDate = function(date){
        return moment(date, "DD/MMM/YY h:mm a").format("MMM Do YYYY h:mm A");
    };

});
</script>